<div class="row">
    <div class="col-md-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Patient Details</h2>
            <div class="btn-group">
                <% if (user.role === 'admin') { %>
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Patient Information Card -->
    <div class="col-md-4 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Patient Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Patient ID:</div>
                    <div class="col-md-7"><%= patient.patientId %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Name:</div>
                    <div class="col-md-7"><%= patient.firstName %> <%= patient.lastName %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Gender:</div>
                    <div class="col-md-7"><%= patient.gender %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Date of Birth:</div>
                    <div class="col-md-7"><%= new Date(patient.dateOfBirth).toLocaleDateString() %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Blood Group:</div>
                    <div class="col-md-7"><%= patient.bloodGroup || 'Not specified' %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Contact:</div>
                    <div class="col-md-7"><%= patient.contactNumber %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Email:</div>
                    <div class="col-md-7"><%= patient.email || 'Not specified' %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Address:</div>
                    <div class="col-md-7"><%= patient.address %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Emergency:</div>
                    <div class="col-md-7"><%= patient.emergencyContact || 'Not specified' %></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-5 fw-bold">Registered:</div>
                    <div class="col-md-7"><%= new Date(patient.registrationDate).toLocaleDateString() %></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointments Card -->
    <div class="col-md-8 mb-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Appointments</h5>
            </div>
            <div class="card-body">
                <% if (appointments && appointments.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Doctor</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% appointments.forEach(appointment => { %>
                                    <tr>
                                        <td><%= new Date(appointment.appointmentDate).toLocaleDateString() %></td>
                                        <td><%= appointment.appointmentTime %></td>
                                        <td>Dr. <%= appointment.Doctor.firstName %> <%= appointment.Doctor.lastName %></td>
                                        <td>
                                            <span class="badge <%= appointment.status === 'scheduled' ? 'bg-warning' : 
                                                   appointment.status === 'completed' ? 'bg-success' : 
                                                   appointment.status === 'cancelled' ? 'bg-danger' : 'bg-secondary' %>">
                                                <%= appointment.status %>
                                            </span>
                                        </td>
                                        <td>
                                            <a href="/appointments/<%= appointment.id %>" class="btn btn-sm btn-info">View</a>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <p class="mb-0">No appointments scheduled.</p>
                <% } %>
            </div>
            <div class="card-footer">
                <a href="/patients/<%= patient.id %>/appointments/new" class="btn btn-primary">
                    <i class="fas fa-calendar-plus"></i> New Appointment
                </a>
            </div>
        </div>
    </div>

    <!-- Actions Row -->
    <div class="col-md-12 mb-4">
        <div class="row">
            <div class="col-md-3 mb-4">
                <a href="/patients/<%= patient.id %>/medical-records" class="btn btn-outline-primary d-block">
                    <i class="fas fa-notes-medical"></i> View Medical Records
                </a>
            </div>
            <div class="col-md-3 mb-4">
                <a href="/lab/new?patientId=<%= patient.id %>" class="btn btn-outline-primary d-block">
                    <i class="fas fa-flask"></i> Request Lab Test
                </a>
            </div>
            <div class="col-md-3 mb-4">
                <button type="button" class="btn btn-outline-primary d-block w-100" data-bs-toggle="modal" data-bs-target="#cabinModal">
                    <i class="fas fa-bed"></i> Manage Cabin
                    <% if (locals.cabin) { %> 
                        <span class="badge bg-success ms-1">Assigned</span>
                    <% } %>
                </button>
            </div>
            <div class="col-md-3 mb-4">
                <a href="/billing/new?patientId=<%= patient.id %>" class="btn btn-outline-primary d-block">
                    <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete patient <%= patient.firstName %> <%= patient.lastName %>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/patients/<%= patient.id %>?_method=DELETE" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cabin Assignment Modal -->
<div class="modal fade" id="cabinModal" tabindex="-1" aria-labelledby="cabinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="cabinModalLabel">Cabin Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <% if (locals.cabin) { %>
                    <div class="alert alert-success">
                        <strong>Currently Assigned to:</strong> Cabin <%= cabin.cabinNumber %>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Cabin Type:</strong> <%= cabin.cabinType.charAt(0).toUpperCase() + cabin.cabinType.slice(1) %>
                            </div>
                            <div class="mb-2">
                                <strong>Floor:</strong> <%= cabin.floor %>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Price Per Day:</strong> $<%= cabin.pricePerDay %>
                            </div>
                            <div class="mb-2">
                                <strong>Admission Date:</strong> <%= new Date(cabin.admissionDate).toLocaleDateString() %>
                            </div>
                        </div>
                    </div>
                    <% if (cabin.notes) { %>
                        <div class="mb-3">
                            <strong>Notes:</strong>
                            <p class="mb-0"><%= cabin.notes %></p>
                        </div>
                    <% } %>
                    <div class="d-flex justify-content-end mt-3">
                        <a href="/cabins/<%= cabin.id %>" class="btn btn-primary me-2">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                        <a href="/cabins/<%= cabin.id %>/discharge" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i> Discharge Patient
                        </a>
                    </div>
                <% } else { %>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No cabin currently assigned to this patient
                    </div>
                    <% if (locals.availableCabins && availableCabins.length > 0) { %>
                        <form action="/cabins/assign-patient" method="POST">
                            <input type="hidden" name="patientId" value="<%= patient.id %>">
                            <div class="mb-3">
                                <label for="cabinId" class="form-label">Select Cabin:</label>
                                <select class="form-select" id="cabinId" name="cabinId" required>
                                    <option value="">-- Select a cabin --</option>
                                    <% availableCabins.forEach(cabin => { %>
                                        <option value="<%= cabin.id %>">
                                            <%= cabin.cabinNumber %> (<%= cabin.cabinType %>, Floor: <%= cabin.floor %>, $<%= cabin.pricePerDay %>/day)
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="admissionDate" class="form-label">Admission Date:</label>
                                <input type="date" class="form-control" id="admissionDate" name="admissionDate" 
                                       value="<%= new Date().toISOString().split('T')[0] %>" required>
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes:</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-bed"></i> Assign Cabin
                                </button>
                            </div>
                        </form>
                    <% } else { %>
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i> No cabins available at the moment.
                        </div>
                        <div class="d-flex justify-content-end">
                            <a href="/cabins" class="btn btn-primary">
                                <i class="fas fa-search"></i> View All Cabins
                            </a>
                        </div>
                    <% } %>
                <% } %>
            </div>
        </div>
    </div>
</div>