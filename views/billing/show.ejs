<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Invoice: <%= billing.invoiceNumber %></h5>
                    <div>
                        <a href="/billing/<%= billing.id %>/edit" class="btn btn-light btn-sm">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="/billing/<%= billing.id %>/print" class="btn btn-light btn-sm" target="_blank">
                            <i class="fas fa-file-invoice"></i> Print-Friendly
                        </a>
                        <button class="btn btn-light btn-sm" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="mb-3">Hospital Information</h5>
                        <p>
                            <strong>Hospital Name</strong><br>
                            123 Hospital Street<br>
                            City, State 12345<br>
                            Phone: (123) 456-7890<br>
                            Email: info@hospital.com
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <h5 class="mb-3">Invoice Details</h5>
                        <p>
                            <strong>Invoice Number:</strong> <%= billing.invoiceNumber %><br>
                            <strong>Date:</strong> <%= new Date(billing.invoiceDate).toLocaleDateString() %><br>
                            <strong>Status:</strong> 
                            <span class="badge <%= billing.paymentStatus === 'paid' ? 'bg-success' : 
                                   billing.paymentStatus === 'partial' ? 'bg-warning' : 'bg-danger' %>">
                                <%= billing.paymentStatus %>
                            </span>
                        </p>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="mb-3">Patient Information</h5>
                        <p>
                            <strong>Name:</strong> <%= billing.Patient.firstName %> <%= billing.Patient.lastName %><br>
                            <strong>Patient ID:</strong> <%= billing.Patient.patientId %><br>
                            <strong>Contact:</strong> <%= billing.Patient.contactNumber %><br>
                            <strong>Email:</strong> <%= billing.Patient.email || 'N/A' %>
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <% if (billing.paymentMethod) { %>
                            <h5 class="mb-3">Payment Information</h5>
                            <p>
                                <strong>Payment Method:</strong> <%= billing.paymentMethod.charAt(0).toUpperCase() + billing.paymentMethod.slice(1) %><br>
                                <% if (billing.paymentDate) { %>
                                    <strong>Payment Date:</strong> <%= new Date(billing.paymentDate).toLocaleDateString() %><br>
                                <% } %>
                                <% if (billing.insuranceDetails && billing.paymentMethod === 'insurance') { %>
                                    <strong>Insurance:</strong> <%= billing.insuranceDetails.company %><br>
                                    <strong>Policy Number:</strong> <%= billing.insuranceDetails.policyNumber %><br>
                                <% } %>
                            </p>
                        <% } %>
                    </div>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (billing.services && Array.isArray(billing.services) && billing.services.length > 0) { %>
                                <% billing.services.forEach(service => { %>
                                    <tr>
                                        <td><%= service.description %></td>
                                        <td class="text-center"><%= service.quantity %></td>
                                        <td class="text-end">$<%= parseFloat(service.price).toFixed(2) %></td>
                                        <td class="text-end">$<%= (parseFloat(service.price) * parseInt(service.quantity)).toFixed(2) %></td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4" class="text-center">No services listed</td>
                                </tr>
                            <% } %>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                <td class="text-end"><strong>$<%= billing.totalAmount %></strong></td>
                            </tr>
                            <% if (billing.discount && billing.discount > 0) { %>
                                <tr>
                                    <td colspan="3" class="text-end text-danger">
                                        <strong>Discount (<%= billing.discountType === 'percentage' ? billing.discount + '%' : '$' + billing.discount %>):</strong>
                                    </td>
                                    <td class="text-end text-danger">
                                        <strong>-$<%= (billing.totalAmount - billing.discountedAmount).toFixed(2) %></strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total After Discount:</strong></td>
                                    <td class="text-end"><strong>$<%= billing.discountedAmount %></strong></td>
                                </tr>
                            <% } %>
                            <tr>
                                <td colspan="3" class="text-end text-success"><strong>Paid Amount:</strong></td>
                                <td class="text-end text-success"><strong>$<%= billing.paidAmount %></strong></td>
                            </tr>
                            <% if ((billing.discount > 0 ? billing.discountedAmount : billing.totalAmount) - billing.paidAmount > 0) { %>
                                <tr>
                                    <td colspan="3" class="text-end text-danger"><strong>Balance Due:</strong></td>
                                    <td class="text-end text-danger"><strong>$<%= ((billing.discount > 0 ? billing.discountedAmount : billing.totalAmount) - billing.paidAmount).toFixed(2) %></strong></td>
                                </tr>
                            <% } %>
                        </tfoot>
                    </table>
                </div>

                <% if (billing.notes) { %>
                    <div class="mb-4">
                        <h5 class="mb-3">Notes</h5>
                        <p><%= billing.notes %></p>
                    </div>
                <% } %>

                <div class="d-flex justify-content-between">
                    <a href="/billing" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Billing Records
                    </a>
                    <% if (billing.paymentStatus !== 'paid') { %>
                        <a href="/billing/<%= billing.id %>/edit" class="btn btn-success">
                            <i class="fas fa-money-bill"></i> Record Payment
                        </a>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>