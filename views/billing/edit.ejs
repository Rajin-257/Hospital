<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title mb-4">Update Invoice: <%= billing.invoiceNumber %></h2>
                <form action="/billing/<%= billing.id %>?_method=PUT" method="POST">
                    <!-- Payment Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Invoice Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Patient:</strong> <%= billing.Patient.firstName %> <%= billing.Patient.lastName %></p>
                                    <p><strong>Invoice Number:</strong> <%= billing.invoiceNumber %></p>
                                    <p><strong>Invoice Date:</strong> <%= new Date(billing.invoiceDate).toLocaleDateString() %></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Amount:</strong> $<%= billing.totalAmount %></p>
                                    <p><strong>Already Paid:</strong> $<%= billing.paidAmount %></p>
                                    <p><strong>Balance:</strong> $<%= (billing.totalAmount - billing.paidAmount).toFixed(2) %></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Update -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Update Payment</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="paidAmount" class="form-label">Total Paid Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" class="form-control" id="paidAmount" name="paidAmount" value="<%= billing.paidAmount %>">
                                    </div>
                                    <small class="text-muted">Enter the total amount paid (including previous payments)</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="paymentMethod" class="form-label">Payment Method</label>
                                    <select class="form-select" id="paymentMethod" name="paymentMethod">
                                        <option value="">Select payment method</option>
                                        <option value="cash" <%= billing.paymentMethod === 'cash' ? 'selected' : '' %>>Cash</option>
                                        <option value="card" <%= billing.paymentMethod === 'card' ? 'selected' : '' %>>Credit/Debit Card</option>
                                        <option value="insurance" <%= billing.paymentMethod === 'insurance' ? 'selected' : '' %>>Insurance</option>
                                        <option value="online" <%= billing.paymentMethod === 'online' ? 'selected' : '' %>>Online Payment</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="insuranceSection" style="display: <%= billing.paymentMethod === 'insurance' ? 'block' : 'none' %>;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="insuranceCompany" class="form-label">Insurance Company</label>
                                        <input type="text" class="form-control" id="insuranceCompany" name="insuranceDetails[company]" value="<%= billing.insuranceDetails && billing.insuranceDetails.company ? billing.insuranceDetails.company : '' %>">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="policyNumber" class="form-label">Policy Number</label>
                                        <input type="text" class="form-control" id="policyNumber" name="insuranceDetails[policyNumber]" value="<%= billing.insuranceDetails && billing.insuranceDetails.policyNumber ? billing.insuranceDetails.policyNumber : '' %>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="mb-4">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"><%= billing.notes %></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/billing/<%= billing.id %>" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update Invoice</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle insurance section based on payment method
        const paymentMethod = document.getElementById('paymentMethod');
        const insuranceSection = document.getElementById('insuranceSection');
        
        if (paymentMethod && insuranceSection) {
            paymentMethod.addEventListener('change', function() {
                if (this.value === 'insurance') {
                    insuranceSection.style.display = 'block';
                } else {
                    insuranceSection.style.display = 'none';
                }
            });
        }
    });
</script>