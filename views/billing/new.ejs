<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title mb-4">Create New Invoice</h2>
                
                <% if (!patient) { %>
                    <!-- Select Patient First -->
                    <form action="/billing/new" method="GET" class="mb-5">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="patientId" class="form-label">Select Patient</label>
                                <select class="form-select" id="patientId" name="patientId" required>
                                    <option value="">Select a patient</option>
                                    <% patients.forEach(patient => { %>
                                        <option value="<%= patient.id %>"><%= patient.firstName %> <%= patient.lastName %> (<%= patient.patientId %>)</option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Continue</button>
                            </div>
                        </div>
                    </form>
                <% } else { %>
                    <!-- Create Invoice Form -->
                    <form action="/billing" method="POST">
                        <input type="hidden" name="patientId" value="<%= patient.id %>">
                        
                        <!-- Patient Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Patient Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Name:</strong> <%= patient.firstName %> <%= patient.lastName %></p>
                                        <p><strong>Patient ID:</strong> <%= patient.patientId %></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Contact:</strong> <%= patient.contactNumber %></p>
                                        <p><strong>Email:</strong> <%= patient.email || 'N/A' %></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Related Services Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">Related Services</h5>
                            </div>
                            <div class="card-body">
                                <!-- Appointments Tab -->
                                <ul class="nav nav-tabs mb-3" id="servicesTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button">Appointments</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="labtests-tab" data-bs-toggle="tab" data-bs-target="#labtests" type="button">Lab Tests</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="cabins-tab" data-bs-toggle="tab" data-bs-target="#cabins" type="button">Cabins</button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="servicesTabContent">
                                    <!-- Appointments Tab Content -->
                                    <div class="tab-pane fade show active" id="appointments" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th width="5%">Select</th>
                                                        <th>Date</th>
                                                        <th>Doctor</th>
                                                        <th>Reason</th>
                                                        <th>Status</th>
                                                        <th width="15%">Price</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="appointmentsTableBody">
                                                    <% if (typeof appointments !== 'undefined' && appointments.length > 0) { %>
                                                        <% appointments.forEach((appointment, index) => { %>
                                                            <tr>
                                                                <td class="text-center">
                                                                    <input type="checkbox" class="service-checkbox" 
                                                                           data-type="appointment"
                                                                           data-id="<%= appointment.id %>"
                                                                           data-description="Appointment with Dr. <%= appointment.Doctor.lastName %> (<%= new Date(appointment.appointmentDate).toLocaleDateString() %>)"
                                                                           data-price="<%= appointment.Doctor.consultationFee || 0 %>">
                                                                </td>
                                                                <td><%= new Date(appointment.appointmentDate).toLocaleDateString() %> <%= appointment.appointmentTime %></td>
                                                                <td>Dr. <%= appointment.Doctor.firstName %> <%= appointment.Doctor.lastName %></td>
                                                                <td><%= appointment.reason %></td>
                                                                <td><span class="badge bg-<%= appointment.status === 'scheduled' ? 'info' : (appointment.status === 'completed' ? 'success' : 'danger') %>">
                                                                    <%= appointment.status %> <%= appointment.invoice_status === 'invoiced' ? '(Invoiced)' : '' %>
                                                                </span></td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" step="0.01" class="form-control appointment-price" 
                                                                               value="<%= appointment.Doctor.consultationFee || 0 %>"
                                                                               min="0">
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="6" class="text-center">No pending appointments found</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Lab Tests Tab Content -->
                                    <div class="tab-pane fade" id="labtests" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th width="5%">Select</th>
                                                        <th>Test Name</th>
                                                        <th>Test Code</th>
                                                        <th>Status</th>
                                                        <th width="15%">Price</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="labTestsTableBody">
                                                    <% if (typeof labTests !== 'undefined' && labTests.length > 0) { %>
                                                        <% labTests.forEach((test, index) => { %>
                                                            <tr>
                                                                <td class="text-center">
                                                                    <input type="checkbox" class="service-checkbox" 
                                                                           data-type="labtest"
                                                                           data-id="<%= test.id %>"
                                                                           data-description="<%= test.testName %> (<%= test.testCode %>)"
                                                                           data-price="<%= test.price %>">
                                                                </td>
                                                                <td><%= test.testName %></td>
                                                                <td><%= test.testCode %></td>
                                                                <td><span class="badge bg-<%= test.status === 'requested' ? 'secondary' : (test.status === 'scheduled' ? 'info' : 'success') %>">
                                                                    <%= test.status %> <%= test.invoice_status === 'invoiced' ? '(Invoiced)' : '' %>
                                                                </span></td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" step="0.01" class="form-control lab-test-price" 
                                                                               value="<%= test.price %>"
                                                                               min="0">
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="5" class="text-center">No pending lab tests found</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Cabins Tab Content -->
                                    <div class="tab-pane fade" id="cabins" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th width="5%">Select</th>
                                                        <th>Cabin Number</th>
                                                        <th>Type</th>
                                                        <th>Admission Date</th>
                                                        <th>Days</th>
                                                        <th width="15%">Price/Day</th>
                                                        <th width="15%">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cabinsTableBody">
                                                    <% if (typeof cabins !== 'undefined' && cabins.length > 0) { %>
                                                        <% cabins.forEach((cabin, index) => { %>
                                                            <% 
                                                                const admissionDate = new Date(cabin.admissionDate);
                                                                const today = new Date();
                                                                const diffTime = Math.abs(today - admissionDate);
                                                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
                                                                const totalPrice = diffDays * cabin.pricePerDay;
                                                            %>
                                                            <tr>
                                                                <td class="text-center">
                                                                    <input type="checkbox" class="service-checkbox" 
                                                                           data-type="cabin"
                                                                           data-id="<%= cabin.id %>"
                                                                           data-description="<%= cabin.cabinNumber %> (<%= cabin.cabinType %>) for <%= diffDays %> days"
                                                                           data-price="<%= totalPrice %>"
                                                                           data-days="<%= diffDays %>">
                                                                </td>
                                                                <td><%= cabin.cabinNumber %></td>
                                                                <td><%= cabin.cabinType %></td>
                                                                <td><%= new Date(cabin.admissionDate).toLocaleDateString() %></td>
                                                                <td>
                                                                    <input type="number" class="form-control cabin-days" 
                                                                           value="<%= diffDays %>"
                                                                           min="1"
                                                                           data-price-per-day="<%= cabin.pricePerDay %>">
                                                                </td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" step="0.01" class="form-control" 
                                                                               value="<%= cabin.pricePerDay %>"
                                                                               readonly>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" step="0.01" class="form-control cabin-total-price" 
                                                                               value="<%= totalPrice %>"
                                                                               readonly>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="7" class="text-center">No occupied cabins found</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Services Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Services & Charges</h5>
                            </div>
                            <div class="card-body">
                                <div id="servicesContainer">
                                    
                                </div>
                                
                                <div class="d-grid">
                                    <button type="button" id="addServiceBtn" class="btn btn-outline-primary">
                                        <i class="fas fa-plus"></i> Add Service
                                    </button>
                                </div>
                                
                                <hr>
                                
                                <div class="row mb-3">
                                    <div class="col-md-8 text-end">
                                        <h5>Total Amount:</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" class="form-control" id="totalAmount" name="totalAmount" readonly required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discount Section -->
                                <div class="row mb-3">
                                    <div class="col-md-5 text-end">
                                        <label for="discount" class="form-label">Discount:</label>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <input type="number" step="0.01" min="0" class="form-control" id="discount" name="discount" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="discountType" name="discountType">
                                            <option value="fixed">Fixed Amount ($)</option>
                                            <option value="percentage">Percentage (%)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-8 text-end">
                                        <h5>Final Amount:</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" class="form-control" id="discountedAmount" name="discountedAmount" readonly required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Payment Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="paidAmount" class="form-label">Paid Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" class="form-control" id="paidAmount" name="paidAmount" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="paymentMethod" class="form-label">Payment Method</label>
                                        <select class="form-select" id="paymentMethod" name="paymentMethod">
                                            <option value="">Select payment method</option>
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="insurance">Insurance</option>
                                            <option value="online">Online Payment</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="insuranceSection" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="insuranceCompany" class="form-label">Insurance Company</label>
                                            <input type="text" class="form-control" id="insuranceCompany" name="insuranceDetails[company]">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="policyNumber" class="form-label">Policy Number</label>
                                            <input type="text" class="form-control" id="policyNumber" name="insuranceDetails[policyNumber]">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section -->
                        <div class="mb-4">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/billing" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Create Invoice</button>
                        </div>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add service button functionality
        let serviceCount = 1;
        const servicesContainer = document.getElementById('servicesContainer');
        const addServiceBtn = document.getElementById('addServiceBtn');
        
        // Get discount inputs and discounted amount
        const discountInput = document.getElementById('discount');
        const discountTypeSelect = document.getElementById('discountType');
        const discountedAmountInput = document.getElementById('discountedAmount');
        
        // Add event listeners for discount calculations
        if (discountInput && discountTypeSelect) {
            discountInput.addEventListener('change', calculateDiscountedAmount);
            discountTypeSelect.addEventListener('change', calculateDiscountedAmount);
        }
        
        // Function to calculate discounted amount
        function calculateDiscountedAmount() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const discountType = discountTypeSelect.value;
            
            let discountAmount = 0;
            let finalAmount = totalAmount;
            
            if (discountType === 'fixed') {
                discountAmount = Math.min(discount, totalAmount); // Discount can't be more than total
                finalAmount = totalAmount - discountAmount;
            } else if (discountType === 'percentage') {
                discountAmount = (totalAmount * Math.min(discount, 100)) / 100; // Cap at 100%
                finalAmount = totalAmount - discountAmount;
            }
            
            // Set discounted amount
            discountedAmountInput.value = finalAmount.toFixed(2);
        }
        
        if (addServiceBtn) {
            addServiceBtn.addEventListener('click', function() {
                const serviceRow = document.createElement('div');
                serviceRow.className = 'row mb-3 service-row';
                serviceRow.innerHTML = `
                    <div class="col-md-5">
                        <input type="text" class="form-control" name="services[${serviceCount}][description]" placeholder="Service Description" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" name="services[${serviceCount}][quantity]" placeholder="Quantity" value="1" min="1" required>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" class="form-control service-price" name="services[${serviceCount}][price]" placeholder="Price" required>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger remove-service">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                servicesContainer.appendChild(serviceRow);
                serviceCount++;
                
                // Enable the first row's remove button if there are multiple rows
                if (document.querySelectorAll('.service-row').length > 1) {
                    document.querySelector('.remove-service').disabled = false;
                }
                
                // Add event listener to new remove button
                serviceRow.querySelector('.remove-service').addEventListener('click', function() {
                    this.closest('.service-row').remove();
                    calculateTotal();
                    
                    // Disable the first row's remove button if only one row remains
                    if (document.querySelectorAll('.service-row').length === 1) {
                        document.querySelector('.remove-service').disabled = true;
                    }
                });
                
                // Add event listeners to new price and quantity inputs
                serviceRow.querySelectorAll('.service-price, input[name$="[quantity]"]').forEach(input => {
                    input.addEventListener('change', calculateTotal);
                });
            });
        }
        
        // Handle service checkboxes
        const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
        
        serviceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    // Add this service to the invoice
                    addServiceToInvoice(
                        this.dataset.type,
                        this.dataset.id,
                        this.dataset.description,
                        this.dataset.price
                    );
                } else {
                    // Remove this service from the invoice
                    removeServiceFromInvoice(this.dataset.type, this.dataset.id);
                }
                
                // Recalculate total
                calculateTotal();
            });
        });
        
        // Handle cabin days change
        const cabinDaysInputs = document.querySelectorAll('.cabin-days');
        
        cabinDaysInputs.forEach(input => {
            input.addEventListener('change', function() {
                const days = parseInt(this.value) || 1;
                const pricePerDay = parseFloat(this.dataset.pricePerDay) || 0;
                const totalPrice = days * pricePerDay;
                
                // Update the total price in the same row
                const row = this.closest('tr');
                const totalPriceInput = row.querySelector('.cabin-total-price');
                if (totalPriceInput) {
                    totalPriceInput.value = totalPrice.toFixed(2);
                }
                
                // Update the checkbox data
                const checkbox = row.querySelector('.service-checkbox');
                if (checkbox) {
                    checkbox.dataset.price = totalPrice.toFixed(2);
                    checkbox.dataset.days = days;
                    
                    // Update description
                    const cabinNumber = row.querySelector('td:nth-child(2)').textContent;
                    const cabinType = row.querySelector('td:nth-child(3)').textContent;
                    checkbox.dataset.description = `${cabinNumber} (${cabinType}) for ${days} days`;
                    
                    // If checkbox is checked, update the service in the invoice
                    if (checkbox.checked) {
                        updateServiceInInvoice(
                            checkbox.dataset.type,
                            checkbox.dataset.id,
                            checkbox.dataset.description,
                            checkbox.dataset.price
                        );
                        
                        // Recalculate total
                        calculateTotal();
                    }
                }
            });
        });
        
        // Function to add a service to the invoice
        function addServiceToInvoice(type, id, description, price) {
            // Add a hidden field for the service reference ID and type
            const form = document.querySelector('form[action="/billing"]');
            const serviceRow = document.createElement('div');
            serviceRow.className = 'row mb-3 service-row';
            serviceRow.dataset.serviceType = type;
            serviceRow.dataset.serviceId = id;
            
            const serviceIndex = serviceCount++;
            
            serviceRow.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" name="services[${serviceIndex}][description]" value="${description}" required readonly>
                    <input type="hidden" name="services[${serviceIndex}][type]" value="${type}">
                    <input type="hidden" name="services[${serviceIndex}][referenceId]" value="${id}">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" name="services[${serviceIndex}][quantity]" value="1" min="1" required readonly>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" class="form-control service-price" name="services[${serviceIndex}][price]" value="${price}" required readonly>
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger remove-linked-service" data-type="${type}" data-id="${id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            servicesContainer.appendChild(serviceRow);
            
            // Add event listener to remove button
            serviceRow.querySelector('.remove-linked-service').addEventListener('click', function() {
                // Uncheck the corresponding checkbox
                const checkbox = document.querySelector(`.service-checkbox[data-type="${this.dataset.type}"][data-id="${this.dataset.id}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                // Remove the service row
                this.closest('.service-row').remove();
                calculateTotal();
            });
        }
        
        // Function to remove a service from the invoice
        function removeServiceFromInvoice(type, id) {
            const serviceRow = document.querySelector(`.service-row[data-service-type="${type}"][data-service-id="${id}"]`);
            if (serviceRow) {
                serviceRow.remove();
            }
        }
        
        // Function to update a service in the invoice
        function updateServiceInInvoice(type, id, description, price) {
            const serviceRow = document.querySelector(`.service-row[data-service-type="${type}"][data-service-id="${id}"]`);
            if (serviceRow) {
                const descInput = serviceRow.querySelector('input[name$="[description]"]');
                const priceInput = serviceRow.querySelector('input[name$="[price]"]');
                
                if (descInput) descInput.value = description;
                if (priceInput) priceInput.value = price;
            }
        }
        
        // Calculate total amount
        function calculateTotal() {
            let total = 0;
            const rows = document.querySelectorAll('.service-row');
            
            rows.forEach(row => {
                const price = parseFloat(row.querySelector('.service-price').value) || 0;
                const quantity = parseInt(row.querySelector('input[name$="[quantity]"]').value) || 0;
                total += price * quantity;
            });
            
            document.getElementById('totalAmount').value = total.toFixed(2);
            
            // Calculate discounted amount after total is updated
            calculateDiscountedAmount();
        }
        
        // Add event listeners to initial price and quantity inputs
        document.querySelectorAll('.service-price, input[name$="[quantity]"]').forEach(input => {
            input.addEventListener('change', calculateTotal);
        });
        
        // Toggle insurance section based on payment method
        const paymentMethod = document.getElementById('paymentMethod');
        const insuranceSection = document.getElementById('insuranceSection');
        
        if (paymentMethod && insuranceSection) {
            paymentMethod.addEventListener('change', function() {
                if (this.value === 'insurance') {
                    insuranceSection.style.display = 'block';
                } else {
                    insuranceSection.style.display = 'none';
                }
            });
        }
        
        // Initialize calculation on page load
        calculateTotal();
    });
</script>